<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Apartment Listings Comparison</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
  </head>
  <body>
    <label for="today-file">Choose Today's file:</label>
    <input type="file" id="today-file" accept=".xlsx" /><br />
    <label for="yesterday-file">Choose Yesterday's file:</label>
    <input type="file" id="yesterday-file" accept=".xlsx" /><br />
    <button id="compare-btn">Compare Listings</button>
    <div id="result"></div>
    <script>
      const todayFile = document.getElementById("today-file");
      const yesterdayFile = document.getElementById("yesterday-file");
      const compareBtn = document.getElementById("compare-btn");
      const resultDiv = document.getElementById("result");

      compareBtn.addEventListener("click", async () => {
        const todayData = await readFile(todayFile.files[0]);
        const yesterdayData = await readFile(yesterdayFile.files[0]);
        const todayListings = getUniqueListings(todayData);
        const yesterdayListings = getUniqueListings(yesterdayData);
        const newProperties = getNewListings(todayListings, yesterdayListings);
        const removedProperties = getNewListings(yesterdayListings, todayListings);
        const todayPropertyCount = todayListings.length;
        const yesterdayPropertyCount = yesterdayListings.length;
        const todayRentAverage = getRentAverage(todayData);
        const yesterdayRentAverage = getRentAverage(yesterdayData);
        resultDiv.innerHTML = `
          <p>Number of Properties Today: ${todayPropertyCount}</p>
          <p>Number of Properties Yesterday: ${yesterdayPropertyCount}</p>
          <p>New Properties:</p>
          <ul>
            ${newProperties.map((property) => `<li>${property.unitId} - ${property.address} ${property.unitNumber}</li>`).join("")}
          </ul>
          <p>Removed Properties:</p>
          <ul>
            ${removedProperties.map((property) => `<li>${property.unitId} - ${property.address} ${property.unitNumber}</li>`).join("")}
          </ul>
          <p>Rent Average Today: $${todayRentAverage}</p>
          <p>Rent Average Yesterday: $${yesterdayRentAverage}</p>
        `;
      });

      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });
            resolve(jsonData);
          };
          reader.readAsArrayBuffer(file);
        });
      }

      function getUniqueListings(data) {
        return data.reduce((acc, row) => {
          const existingProperty = acc.find((property) => property.unitId === row[2]);
          if (!existingProperty) {
            acc.push({
              unitId: row[2],
              address: row[7],
              unitNumber: row[8],
            });
          }
          return acc;
        }, []);
      }

      function getNewListings(listings1, listings2) {
        return listings
